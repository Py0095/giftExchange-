<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Realtime Database</title>
</head>
<body>
    <h1>Exemple Firebase Realtime Database</h1>
    
    <h2>Ajouter un Code :</h2>
    <input type="text" id="codeInput" placeholder="Entrez un code">
    <input type="text" id="nameInput" placeholder="Entrez un nom">
    <button onclick="writeCodeData()">Ajouter Code</button>

    <h2>Liste des Codes :</h2>
    <select id="codeSelection">
        <option value="">Sélectionnez un code</option>
    </select>

    <h2>Voir le Code :</h2>
    <button onclick="readCodeData()">Voir le Code</button>

    <script type="module">
        // Importer les fonctions nécessaires de Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";
        import { getDatabase, ref, set, get, child, onValue } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Votre configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCNx2baJclL_VtjuH_sThSx9ATDmpjfYlA",
            authDomain: "giftexchange-329a9.firebaseapp.com",
            projectId: "giftexchange-329a9",
            storageBucket: "giftexchange-329a9.firebasestorage.app",
            messagingSenderId: "450675271562",
            appId: "1:450675271562:web:3b3bb22fe2ad122770ca73",
            measurementId: "G-8PS44TP2RZ"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        // Initialiser la base de données Firebase
        const database = getDatabase(app);

        // Fonction pour ajouter des données dans Firebase
        function writeCodeData() {
            const code = document.getElementById("codeInput").value;
            const name = document.getElementById("nameInput").value;

            if (code && name) {
                set(ref(database, 'codes/' + code), {
                    name: name
                }).then(() => {
                    console.log('Code ajouté avec succès');
                    updateSelectMenu();  // Mettre à jour la liste des codes
                }).catch((error) => {
                    console.error('Erreur lors de l\'ajout du code:', error);
                });
            } else {
                alert("Veuillez remplir les champs.");
            }
        }

        // Fonction pour lire les données d'un code depuis Firebase
        function readCodeData() {
            const code = document.getElementById("codeInput").value;

            if (code) {
                const dbRef = ref(database);
                get(child(dbRef, 'codes/' + code)).then((snapshot) => {
                    if (snapshot.exists()) {
                        console.log('Nom associé au code:', snapshot.val().name);
                        alert("Nom associé au code : " + snapshot.val().name);
                    } else {
                        console.log('Aucune donnée trouvée pour ce code.');
                        alert('Aucune donnée trouvée pour ce code.');
                    }
                }).catch((error) => {
                    console.error('Erreur lors de la lecture des données:', error);
                });
            } else {
                alert("Veuillez entrer un code.");
            }
        }

        // Fonction pour mettre à jour le menu de sélection avec les codes Firebase
        function updateSelectMenu() {
            const selectElement = document.getElementById("codeSelection");
            const dbRef = ref(database);

            get(child(dbRef, 'codes')).then((snapshot) => {
                if (snapshot.exists()) {
                    selectElement.innerHTML = "<option value=''>Sélectionnez un code</option>";  // Réinitialiser la liste
                    snapshot.forEach((childSnapshot) => {
                        const code = childSnapshot.key;
                        const name = childSnapshot.val().name;
                        const option = document.createElement("option");
                        option.value = code;
                        option.textContent = code + " - " + name;
                        selectElement.appendChild(option);
                    });
                } else {
                    console.log("Aucun code disponible.");
                }
            }).catch((error) => {
                console.error('Erreur lors de la récupération des codes:', error);
            });
        }

        // Fonction pour écouter les changements en temps réel dans la base de données
        function listenForChanges() {
            const dbRef = ref(database);
            onValue(dbRef, (snapshot) => {
                if (snapshot.exists()) {
                    console.log("Données mises à jour:", snapshot.val());
                    // Mettre à jour l'interface utilisateur si nécessaire
                    updateSelectMenu();
                } else {
                    console.log("Aucune donnée disponible.");
                }
            });
        }

        // Démarrer l'écoute des changements en temps réel
        listenForChanges();

        // Mettre à jour le menu de sélection dès que la page est chargée
        updateSelectMenu();
    </script>
</body>
</html>
